## 動機と目的
フィッシング対策協議会の 2025/04
[月次レポート](https://www.antiphishing.jp/report/monthly/202504.html)によれば，
ある調査用メールアドレス宛に届いた4月のフィッシングメールの8割以上が，
逆引きが設定されていない送信元からのメールであったことが報告されている．

>逆引き (PTR レコード) 設定がされていない IP アドレスからの送信は約 83.5 % となり、
2025 年になってから調査用メールアドレスに着信するフィッシングメールの 8 割以上が
逆引き未設定の IP アドレスから送信され続けています。

Google社の[Email sender Guidelines](https://support.google.com/a/answer/81126)
においても，
以下の通り全てのメール送信者に対して，
送信ドメイン名とIPアドレスに対して正逆が正しい(valid)なDNSレコードを設定することを求めている．

>Ensure that sending domains or IPs have valid forward and reverse DNS records, also referred to as PTR records.

とはいえ，[SMTP](https://www.rfc-editor.org/rfc/rfc5321.txt)
(Simple Mail Transfer Protocol) の仕様としても，
送信元のIP アドレスに対して逆引きを設定することは求めてこなかったこともあり，
現実にはまだ多くの送信メールサーバに逆引きが設定されていない可能性もある．

フィッシングを含む迷惑メール対策として，
この送信元メールサーバの IP アドレスに対して逆引きが設定されているか否かの区別が，
有効であるのであれば，
積極的に活用すべきであり，
他の判断技術 (メールフィルタやドメインレピュテーションなど) と組み合わせることで，
より大きな効果が得られる可能性もある．

## 調査手法

一般に，
メールの送信先 (受信メールサーバ) については，
送信しようとする宛先ドメイン名がわかれば，
そのドメイン名に対する MX レコードを DNS で参照することで，
送信先のホスト (FQDN, IP アドレスともに) を得ることができる．
しかしながら，
メール受信側から見て送信側の出口となるホスト (IP アドレス) については，
これまでは指定あるいは公開する必要も無かったため，
実際にメールを受信するまでは得ることができない情報であった．
これに対して，
送信ドメイン認証技術 [SPF](https://www.rfc-editor.org/rfc/rfc7208.txt)
(Sender Policy Framework) は，
実質的にメールの出口を公開することで，
正規のメール送信元であるかを判断する技術であり，
これを利用することで，
ドメイン名単位でメールの送信元を得ることができるようになる．

SPFは，
特に国内での普及率は高く，
総務省が集計している[統計データ](https://www.soumu.go.jp/main_sosiki/joho_tsusin/d_syohi/m_mail.html#toukei)によれば，
2024年3月時点で90%以上の受信メールがSPFに対応している．
メールに利用しているドメイン名を集めることができれば，
その母集団に対してのメールの出口 (IP アドレス) をある程度特定することができ，
それらの IP アドレスにどの程度 PTR レコードが設定されているかを調べることができるはずである．

また，
IP アドレスの逆引きの設定は，
特に迷惑メールの送信元について地域 (国) ごとに差があるとも言われており，
IP アドレスから地域を合わせて特定していくことで，
これらに関係があるのかについても，
明らかにさせることができる．

### IP アドレスの逆引き

IP アドレスに対する逆引きを求めるには，
通常の DNS の名前解決と少し違った方法になります．
一般に IP アドレスは，
先頭のオクテット側から順番にネットワークの範囲が絞られていいきます．
一方，
ドメイン名は一番右側のラベルから "." で区切られ，
左側に行くほど対象の範囲が狭まっていきます．
そのため，
IP アドレスに対する逆引きを得る場合は，
これらの関係を頭に入れる必要があります．

```sh-session
$ dig +short kantei.go.jp a
3.166.244.42
3.166.244.101
3.166.244.21
3.166.244.31

$ dig +short 42.244.166.3.in-addr.arpa ptr
server-3-166-244-42.nrt20.r.cloudfront.net.

$ dig +short -x 3.166.244.42
server-3-166-244-42.nrt20.r.cloudfront.net.

```

UNIX 系 OS での dig コマンドでは，
-x オプションを付けることで IP アドレス から直接逆引きを得ることができます．


### IP アドレスの地域

IP アドレスは，
IANA および「インターネットレジストリ」によって管理されており，
WHOIS や RDAP により参照することができる．
また [MAXMIND社](https://www.maxmind.com/) は，
GeoIP サービスを提供しており，
そのうち GeoLite データベースに関しては，
現在でも free で利用できる^[事前にユーザ登録が必要となった]．
以下，
GeoLite データベースを入手できたとして，
Python で国情報を出力させるコードを示す．

```py
import geoip2.database

reader = geoip2.database.Reader('./GeoLite2-Country.mmdb')
response = reader.country('3.166.244.101')
print(response.country.iso_code)
```

実行結果は以下の通り^[kantei.go.jp の IP であるが AWS 上にあるため米国(US)となった]．

```sh-session
$ python3 ./geotest.py
US
```

### SPFから送信元IPの取得

ドメイン名がわかれば，
その SPF レコードを参照して，
当該ドメイン名を送信ドメインとして送信するメールの正規のホスト (IP アドレス) を求めることができます．
以下，
*kantei.go.jp* ドメインを例に示す．

```sh-session
$ dig +short kantei.go.jp txt
"MS=ms71830828"
"v=spf1 include:spf.securemx.jp. include:spf.protection.outlook.com -all"
"MS=4EDE4CC0C8C2ECC3468C6740E22686CAD3A029B9"
$ dig +short spf.securemx.jp txt
"v=spf1 ip4:210.130.202.128/29 ip4:210.130.202.48/29 ip4:210.130.202.152/29 ip4:210.130.202.160/28 ip6:2001:240:bb81::4:1000/119 ip4:210.130.202.101/32 ip4:210.130.202.102/31 ip4:210.130.202.104/32 ~all"
$ dig +short spf.protection.outlook.com txt
"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/15 ip4:52.102.0.0/16 ip4:52.103.0.0/17 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/49 ip6:2a01:111:f403:8000::/51 ip6:2a01:111:f403:c000::/51 ip6:2a01:111:f403:f000::/52 -all"
```

IPv6 を考えないとすれば，
当該ドメイン名の正規のメールは，
以下のアドレス帯から送信されるもののみ，
と考えることができる．

IP netowrk | IP address 数
---------: | ------------:
210.130.202.128/29	| 8
210.130.202.48/29	| 8
210.130.202.152/29	| 8
210.130.202.160/28	| 16
210.130.202.101/32	| 1
210.130.202.102/31	| 2
210.130.202.104/32	| 1
40.92.0.0/15		| 131,072
40.107.0.0/16		| 65,536
52.100.0.0/15		| 131,072
52.102.0.0/16		| 65,536
52.103.0.0/17		| 32,768
104.47.0.0/17		| 32,768 
total			| 458,796

メールサービスを利用している場合は，
SPF の *include* 機構を利用して IP アドレスを取り込む場合が多いため，
これら *include* 先の SPF レコードのドメイン名を記憶し，
以降の同じドメイン名が指定されていた場合は，
最初の調査結果を利用する，
といったことができる．
